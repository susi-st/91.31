<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±å¹³å°è¤‡ç¿’å°æ¸¬é©—</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* å­—é«”è¨­å®š */
        body {
            font-family: 'Fredoka', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: #fce7f3; /* æŸ”å’Œç²‰è‰²èƒŒæ™¯ */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        /* æ¡Œé¢æ¸¬é©—å®¹å™¨ */
        .quiz-desktop-container {
            width: 100%;
            max-width: 1000px; /* å¯¬å»£çš„æ¡Œé¢è¦–åœ– */
            min-height: 80vh;
            background-color: #ffffff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; /* è®“å…§å®¹å‚ç›´æ’åˆ— */
        }

        /* å…§å®¹å®¹å™¨ */
        .content-container {
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
        }

        /* è‡ªå®šç¾©è¨Šæ¯æ¡† (å®šä½åˆ°é ‚éƒ¨ä¸­å¤®) */
        #message-box.opacity-100 {
            top: 4rem; /* ä½æ–¼é ‚éƒ¨ï¼Œé¿å…é®æ“‹ä½œç­”å€ */
            position: fixed;
            z-index: 100;
        }

        /* --- Drag and Drop Styles (Q1) --- */
        .drag-item {
            cursor: grab;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2);
            border: 2px solid;
            transition: all 0.15s;
            touch-action: none;
            background-color: white;
            user-select: none; 
        }
        .dragging {
            opacity: 0.5;
            transform: scale(0.9);
            cursor: grabbing;
        }

        .drop-zone {
            display: inline-block;
            min-width: 4rem; 
            min-height: 1.5rem;
            padding: 0 4px;
            border-bottom: 2px dashed #a855f7; 
            margin: 0 0.5rem;
            vertical-align: middle;
        }
        .drop-zone.filled {
             border-bottom: none; 
        }
        .drop-zone.drag-over {
            background-color: #f3e8ff; 
        }
        
        /* --- Category Styles --- */
        .category-target {
            min-height: 120px;
            padding: 1rem;
            border: 3px dashed;
            border-radius: 16px;
            transition: all 0.2s;
        }
        .category-target.drag-over {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.7) !important;
            border-style: solid;
        }
        .category-item {
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2);
            border: 2px solid;
            transition: all 0.15s;
            background-color: white;
            color: #374151;
            font-size: 0.9rem;
            width: 110px; 
            height: 100px;
            flex-shrink: 0;
            margin: 4px;
        }
        .category-item .emoji {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        /* ç¢ºä¿é …ç›®æ‰å…¥å¾Œä½”æ»¿æ•´å€‹å®¹å™¨ */
        .category-target .item-container .category-item,
        .fixed-slot .drag-item,
        .fixed-slot .category-item {
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0;
            border: none;
            box-shadow: none;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* å›ºå®šæ–¹æ¡† (Slots) é€šç”¨æ¨£å¼ */
        .fixed-slot {
            width: 100px;
            height: 100px;
            border: 3px dashed #cbd5e1; /* è™›ç·šé‚Šæ¡† */
            border-radius: 12px;
            background-color: #f1f5f9; /* æ·ºç°åº•è‰² */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin: 5px; /* é–“è· */
        }
        .fixed-slot.drag-over {
            background-color: #e0e7ff;
            border-color: #6366f1;
            transform: scale(1.05);
        }

        /* Q3 äº”å¤§å–®å…ƒæ¨£å¼ */
        .q3-desc-box {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .q3-desc-text {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        /* Q5, Q6 é€Ÿåº¦æ¨™é¡Œ */
        .q-row-layout {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .q-label-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #10b981; 
            text-align: center;
            margin-right: 20px;
            width: 120px;
        }

        /* Q7 é›»è…¦å…ƒä»¶ç™¼å±•å² (æ°´å¹³æ’åˆ—) */
        .gen-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            width: 100%;
        }
        .gen-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .gen-header {
            width: 100%;
            padding: 10px 0;
            text-align: center;
            font-weight: bold;
            color: white;
        }
        .gen-body {
            padding: 15px;
            display: flex;
            justify-content: center;
            width: 100%;
            min-height: 120px; /* ç¢ºä¿æœ‰è¶³å¤ ç©ºé–“æ”¾æ ¼å­ */
        }

        /* --- Q2 Table Selection Styles --- */
        .table-check-container {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .table-check-container th {
            background-color: #f9a8d4; 
            color: white;
            font-weight: 600;
            padding: 12px 10px;
            text-align: center;
            transition: background-color 0.3s; 
        }
        .table-check-container td:first-child {
            font-weight: bold;
            color: #4b5563;
            text-align: left;
            width: 30%; 
            transition: all 0.3s;
        }
        .table-check-container td {
            background-color: #fff;
            border-bottom: 1px solid #fce7f3;
            padding: 10px;
            text-align: center;
            transition: background-color 0.3s;
        }
        .check-box-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .check-box {
            width: 32px;
            height: 32px;
            border: 2px solid #a855f7; 
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            background-color: #f3e8ff;
        }
        .check-box.checked {
            background-color: #a855f7;
            border-color: #a855f7;
            transform: scale(1.05);
        }
        .check-mark {
            color: white;
            font-size: 20px;
            line-height: 1;
            transition: opacity 0.15s;
        }
        
        /* Q5 é€Ÿåº¦æ¨™é¡Œçš„ç‰¹æ®Šæ¨£å¼ */
        .q5-speed-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #10b981; 
            text-align: center;
            margin: 0 10px;
            flex-shrink: 0;
            line-height: 1.2;
        }
        
        /* Q6 è¡¨æ ¼åˆ— */
        .q5-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            padding: 10px 0;
        }
        .q5-slots {
            display: flex;
            gap: 15px; /* å¢åŠ é–“è· */
            flex-grow: 1;
            justify-content: center; /* ç¢ºä¿ç½®ä¸­ */
            align-items: center;
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Quiz å®¹å™¨ -->
    <div id="quiz-container" class="quiz-desktop-container">
        <div class="content-container"> 
            
            <!-- æ¨™é¡Œå€åŸŸ -->
            <header class="mb-6 text-center">
                <div class="inline-block bg-white px-6 py-2 rounded-full shadow-sm mb-4">
                    <span class="text-pink-500 font-bold tracking-wider">UNIT 1 REVIEW</span>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 drop-shadow-sm">
                    ğŸ’» ç³»çµ±å¹³å°å°æ¸¬é©—
                </h1>
            </header>

            <!-- åˆå§‹ç•«é¢ -->
            <div id="start-screen" class="text-center flex-1 flex flex-col justify-center items-center h-full">
                <div class="bg-white p-8 rounded-[3rem] shadow-xl mb-8 w-64 h-64 flex items-center justify-center border-4 border-pink-200 animate-bounce">
                    <span class="text-8xl">ğŸš€</span>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold mb-3 text-gray-700">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                <p class="text-lg text-gray-500 mb-8">è®“æˆ‘å€‘ä¾†è¤‡ç¿’ä¸€ä¸‹èª²æœ¬é‡é»å§ï¼</p>
                
                <button onclick="startQuiz()" class="w-full max-w-xs bg-gradient-to-r from-green-400 to-green-500 text-white text-2xl font-bold py-4 rounded-2xl shadow-3d hover:brightness-105 active:scale-95 transition-all">
                    é–‹å§‹æŒ‘æˆ°
                </button>
            </div>

            <!-- ç­”é¡Œä»‹é¢ -->
            <div id="question-display" class="hidden flex-1 flex flex-col">
                <!-- é¡Œç›®å¡ç‰‡ -->
                <div class="bg-white rounded-3xl p-6 shadow-lg mb-6 border-l-8 border-purple-400">
                    <div class="flex items-center mb-4">
                        <span class="bg-purple-100 text-purple-600 px-3 py-1 rounded-lg font-bold text-sm mr-2">QUESTION</span>
                        <span id="question-number" class="text-2xl font-bold text-purple-600"></span>
                    </div>
                    <!-- é¡Œç›®æ–‡å­—å€åŸŸ (å¤šç”¨æ–¼ D&D é¡Œç›®çš„æŒ‡ä»¤æˆ– Match é¡Œçš„æ¨™é¡Œ) -->
                    <div id="question-text-wrapper" class="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                         <p id="question-text"></p>
                    </div>
                </div>

                <!-- é¸é …/æ‹–æ›³/é€£é€£çœ‹å€å¡Š -->
                <div id="options-container" class="space-y-4 mb-8 flex-1">
                    <!-- JS å‹•æ…‹ç”Ÿæˆé¸é … -->
                </div>

                <!-- å°è¦½èˆ‡ç¢ºèªæŒ‰éˆ• -->
                <div class="mt-auto pt-4 flex justify-between items-center">
                    <button id="prev-btn" onclick="prevQuestion()" class="px-4 py-2 bg-gray-300 rounded-xl shadow-md hover:bg-gray-400 transition text-gray-800 font-bold" disabled>ä¸Šä¸€é¡Œ</button>
                    
                    <button onclick="checkAnswer()" class="max-w-xs bg-gray-800 text-white text-lg font-bold py-3 px-8 rounded-xl shadow-3d hover:bg-gray-700 active:scale-95 transition-all flex items-center justify-center">
                        <span>ç¢ºèªç­”æ¡ˆ</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </button>
                    
                    <button id="next-btn" onclick="nextQuestion()" class="px-4 py-2 bg-purple-500 text-white rounded-xl shadow-md hover:bg-purple-600 transition font-bold">ä¸‹ä¸€é¡Œ</button>
                </div>
            </div>

            <!-- çµæœç•«é¢ -->
            <div id="result-display" class="hidden text-center flex-1 flex flex-col justify-center items-center">
                <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border-4 border-dashed border-gray-300">
                    <div id="result-icon" class="text-8xl mb-4">ğŸ‰</div>
                    <h2 id="final-message" class="text-3xl font-extrabold mb-2"></h2>
                    <div class="my-6">
                        <span class="text-gray-400 text-sm uppercase tracking-widest">Score</span>
                        <div class="text-6xl font-bold text-gray-800" id="final-score-number"></div>
                        <p id="final-score-text" class="text-gray-500 mt-2"></p>
                    </div>
                    <button onclick="restartQuiz()" class="w-full bg-yellow-400 text-yellow-900 text-xl font-bold py-3 rounded-xl shadow-3d hover:bg-yellow-300 active:scale-95 transition-all">
                        å†ç©ä¸€æ¬¡
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="text/javascript">
        // æ¸¬é©—é¡Œç›®è³‡æ–™
        const quizData = [
            {
                type: 'drag_and_drop', // Q1: æ‹–æ›³å¡«ç©º
                question: "ç³»çµ±å¹³å°åˆç¨±[__]å¹³è‡ºï¼ŒæŒ‡çš„æ˜¯åˆ©ç”¨é›»è…¦çš„[__]ï¼Œä¾†æä¾›ä½¿ç”¨è€…å„é …[__]çš„[__]ã€‚",
                blanks: ["é‹ç®—", "é‹ç®—èƒ½åŠ›", "æœå‹™", "åŸ·è¡Œç’°å¢ƒ"], 
                options: ["é‹ç®—", "é‹ç®—èƒ½åŠ›", "æœå‹™", "åŸ·è¡Œç’°å¢ƒ"],
            },
            {
                type: 'table_selection', // Q2: è¡¨æ ¼å‹¾é¸ 
                question: "è«‹å°‡ä¸‹åˆ—ç³»çµ±å¹³å°ï¼Œåˆ†é¡ç‚ºã€Œå‚³çµ±ç³»çµ±å¹³å°ã€æˆ–ã€Œæ–°èˆˆç³»çµ±å¹³å°ã€ã€‚",
                columns: ["å¹³å°ç¨®é¡", "å‚³çµ±ç³»çµ±å¹³å°", "æ–°èˆˆç³»çµ±å¹³å°"],
                // 0: å‚³çµ±, 1: æ–°èˆˆ (ç”¨æ–¼å…§éƒ¨æª¢æŸ¥)
                platformData: [
                    { name: "é›»è…¦ç³»çµ±å¹³å°", classification: 0 },
                    { name: "å¯æ”œå¼ç³»çµ±å¹³å°", classification: 1 },
                    { name: "é›²ç«¯ç³»çµ±å¹³å°", classification: 1 },
                    { name: "åµŒå…¥å¼ç³»çµ±å¹³å°", classification: 1 },
                ]
            },
            {
                type: 'dnd_units_reverse', // Q3: äº”å¤§å–®å…ƒ (åè½‰: å…ƒä»¶æ‹–æ›³åˆ°åŠŸèƒ½)
                question: "è«‹å°‡ä¸Šæ–¹çš„äº”å¤§å–®å…ƒåç¨±ï¼Œæ‹–æ›³è‡³ä¸‹æ–¹å°æ‡‰çš„åŠŸèƒ½æè¿°æ–¹æ¡†ä¸­ã€‚",
                units: [
                    { name: "è¼¸å…¥å–®å…ƒ", unitId: 'input', emoji: 'ğŸ“¥' },
                    { name: "è¼¸å‡ºå–®å…ƒ", unitId: 'output', emoji: 'ğŸ“¤' },
                    { name: "è¨˜æ†¶å–®å…ƒ", unitId: 'memory', emoji: 'ğŸ’¾' },
                    { name: "æ§åˆ¶å–®å…ƒ", unitId: 'control', emoji: 'ğŸ®' },
                    { name: "ç®—è¡“èˆ‡é‚è¼¯å–®å…ƒ", unitId: 'alu', emoji: 'â•' }
                ],
                descriptions: [
                    { text: "è¼¸å…¥å¤–éƒ¨è³‡è¨Šåˆ°ç³»çµ±å…§", unitId: 'input', color: 'bg-red-100 border-red-300' },
                    { text: "è¼¸å‡ºé‹ç®—çµæœåˆ°è¨­å‚™ä¸­", unitId: 'output', color: 'bg-green-100 border-green-300' },
                    { text: "é€²è¡Œè³‡è¨Šçš„å„²å­˜", unitId: 'memory', color: 'bg-yellow-100 border-yellow-300' },
                    { text: "æ§åˆ¶ã€å”èª¿å„å–®å…ƒä¹‹é–“çš„åˆä½œ", unitId: 'control', color: 'bg-blue-100 border-blue-300' },
                    { text: "é€²è¡ŒäºŒé€²ä½çš„é‹ç®—å’Œé‚è¼¯é‹ç®—", unitId: 'alu', color: 'bg-purple-100 border-purple-300' }
                ]
            },
            {
                type: 'category_bucket', // Q4: æ‡‰ç”¨å¯¦ä¾‹
                question: "è«‹å°‡ä¸Šæ–¹çš„å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹ï¼Œæ‹–æ›³è‡³ä¸‹æ–¹çš„æ­£ç¢ºç³»çµ±å¹³å°åˆ†é¡ä¸­ã€‚",
                categories: [
                    { name: "é›»è…¦ç³»çµ±å¹³å°", id: 'traditional', color: 'border-orange-400 bg-orange-50' },
                    { name: "å¯æ”œå¼ç³»çµ±å¹³å°", id: 'portable', color: 'border-blue-400 bg-blue-50' },
                    { name: "é›²ç«¯ç³»çµ±å¹³å°", id: 'cloud', color: 'border-green-400 bg-green-50' },
                    { name: "åµŒå…¥å¼ç³»çµ±å¹³å°", id: 'embedded', color: 'border-purple-4ä¸ª bg-purple-50' }
                ],
                items: [
                    { name: "ç­†è¨˜å‹é›»è…¦ (NB)", categoryId: 'traditional', emoji: 'ğŸ’»' },
                    { name: "æ™ºæ…§å‹æ‰‹æ©Ÿ", categoryId: 'portable', emoji: 'ğŸ“±' },
                    { name: "Gmail/é›²ç«¯éƒµä»¶", categoryId: 'cloud', emoji: 'ğŸ“§' },
                    { name: "å…¨è‡ªå‹•æ´—è¡£æ©Ÿ", categoryId: 'embedded', emoji: 'ğŸ§º' }
                ]
            },
            {
                type: 'category_slots', // Q5: I/O (4 slots each - 2x2 layout)
                question: "è«‹å°‡ä¸‹åˆ—é€±é‚Šè¨­å‚™ï¼Œæ‹–æ›³è‡³æ­£ç¢ºçš„é›»è…¦å–®å…ƒåˆ†é¡æ ¼å­ä¸­ (ä¸€æ ¼ä¸€å€‹)ã€‚",
                categories: [
                    { name: "è¼¸å…¥å–®å…ƒ (Input)", id: 'input', color: 'border-pink-400 bg-pink-100', slots: 4 },
                    { name: "è¼¸å‡ºå–®å…ƒ (Output)", id: 'output', color: 'border-cyan-400 bg-cyan-100', slots: 4 }
                ],
                items: [
                    { name: "æ”å½±æ©Ÿ", categoryId: 'input', emoji: 'ğŸ¥' },
                    { name: "éµç›¤", categoryId: 'input', emoji: 'âŒ¨ï¸' },
                    { name: "æ»‘é¼ ", categoryId: 'input', emoji: 'ğŸ–±ï¸' },
                    { name: "éº¥å…‹é¢¨", categoryId: 'input', emoji: 'ğŸ¤' },
                    { name: "è€³æ©Ÿ", categoryId: 'output', emoji: 'ğŸ§' }, 
                    { name: "å–‡å­", categoryId: 'output', emoji: 'ğŸ”Š' },
                    { name: "å°è¡¨æ©Ÿ", categoryId: 'output', emoji: 'ğŸ–¨ï¸' },
                    { name: "è¢å¹•", categoryId: 'output', emoji: 'ğŸ–¥ï¸' }
                ]
            },
            {
                type: 'table_sort_random', // Q6: è¨˜æ†¶é«”éšå±¤ (éš¨æ©ŸåŒ–)
                question: "è«‹ä¾æ“šæŒ‡å®šæ¢ä»¶ï¼Œå°‡è¨˜æ†¶é«”ç¨®é¡æ‹–æ›³è‡³è¡¨æ ¼ä¸­çš„æ­£ç¢ºä½ç½®ã€‚",
                // é¡Œç›®å°‡åœ¨è¼‰å…¥æ™‚å‹•æ…‹ç”Ÿæˆ
                variations: [
                    { labelStart: "å­˜å–é€Ÿåº¦", labelEnd: "å¿« â®• æ…¢", type: "speed_fast_slow", order: ["register", "cache", "ram", "secondary"] },
                    { labelStart: "å­˜å–é€Ÿåº¦", labelEnd: "æ…¢ â®• å¿«", type: "speed_slow_fast", order: ["secondary", "ram", "cache", "register"] },
                    { labelStart: "åƒ¹æ ¼", labelEnd: "é«˜ â®• ä½", type: "price_high_low", order: ["register", "cache", "ram", "secondary"] },
                    { labelStart: "åƒ¹æ ¼", labelEnd: "ä½ â®• é«˜", type: "price_low_high", order: ["secondary", "ram", "cache", "register"] },
                    { labelStart: "å®¹é‡", labelEnd: "å¤§ â®• å°", type: "cap_large_small", order: ["secondary", "ram", "cache", "register"] },
                    { labelStart: "å®¹é‡", labelEnd: "å° â®• å¤§", type: "cap_small_large", order: ["register", "cache", "ram", "secondary"] }
                ],
                sourceItems: [
                    { id: 'register', name: "æš«å­˜å™¨", emoji: "âš¡" },
                    { id: 'cache', name: "å¿«å–", emoji: "ğŸš…" },
                    { id: 'ram', name: "ä¸»è¨˜æ†¶é«”", emoji: "ğŸ§ " },
                    { id: 'secondary', name: "è¼”åŠ©è¨˜æ†¶é«”", emoji: "ğŸ’¾" }
                ]
            },
            {
                 type: 'category_slots_gen', // Q7: é›»è…¦å…ƒä»¶ç™¼å±•å²
                 question: "è«‹å°‡ä¸‹æ–¹çš„é›»è…¦ä¸»è¦å…ƒä»¶ï¼Œæ‹–æ›³åˆ°å°æ‡‰çš„é›»è…¦ä¸–ä»£ (æ°´å¹³æ’åˆ—)ã€‚",
                 categories: [
                    { name: "ç¬¬ä¸€ä»£", id: 'gen1', color: 'bg-red-500', slots: 1 },
                    { name: "ç¬¬äºŒä»£", id: 'gen2', color: 'bg-orange-500', slots: 1 },
                    { name: "ç¬¬ä¸‰ä»£", id: 'gen3', color: 'bg-yellow-500', slots: 1 },
                    { name: "ç¬¬å››ä»£", id: 'gen4', color: 'bg-green-500', slots: 1 },
                    { name: "ç¬¬äº”ä»£", id: 'gen5', color: 'bg-blue-500', slots: 1 }
                 ],
                 items: [
                     { name: "ç©é«”é›»è·¯ (IC)", categoryId: 'gen3', emoji: 'ğŸ”¸' },
                     { name: "çœŸç©ºç®¡", categoryId: 'gen1', emoji: 'ğŸ’¡' },
                     { name: "è¶…å¤§å‹ç©é«”é›»è·¯ (VLSI)", categoryId: 'gen4', emoji: 'ğŸ”º' },
                     { name: "é›»æ™¶é«”", categoryId: 'gen2', emoji: 'ğŸ”˜' },
                     { name: "å°å…ƒä»¶ã€å¤šæ ¸å¿ƒ", categoryId: 'gen5', emoji: 'ğŸŒ' }
                 ]
            },
            {
                 type: 'drag_and_drop_2col', // Q8: è‹±æ–‡ç¸®å¯«
                 question: "è«‹å°‡å·¦å´çš„è‹±æ–‡ç¸®å¯«ï¼Œæ‹–æ›³åˆ°å³å´æ­£ç¢ºçš„ä¸­æ–‡åç¨±ä¸Šã€‚",
                 leftItems: [
                     { name: "Big Data", value: 'big_data' },
                     { name: "AI", value: 'ai' },
                     { name: "IoT", value: 'iot' }
                 ],
                 rightItems: [
                     { name: "äººå·¥æ™ºæ…§", correctValue: 'ai' },
                     { name: "ç‰©è¯ç¶²", correctValue: 'iot' },
                     { name: "å¤§æ•¸æ“š", correctValue: 'big_data' }
                 ]
            }
        ];

        let currentQuestionIndex = 0;
        let questionStatuses = Array(quizData.length).fill(null); 
        let answers = {}; 

        const colorPalettes = [
            { bg: 'bg-red-100', border: 'border-red-400', text: 'text-red-800', hex: '#fee2e2' }, 
            { bg: 'bg-orange-100', border: 'border-orange-400', text: 'text-orange-800', hex: '#ffedd5' }, 
            { bg: 'bg-green-100', border: 'border-green-400', text: 'text-green-800', hex: '#d1fae5' }, 
            { bg: 'bg-blue-100', border: 'border-blue-400', text: 'text-blue-800', hex: '#dbeafe' }, 
            { bg: 'bg-purple-100', border: 'border-purple-400', text: 'text-purple-800', hex: '#f3e8ff' }, 
            { bg: 'bg-pink-100', border: 'border-pink-400', text: 'text-pink-800', hex: '#fce7f3' }, 
            { bg: 'bg-teal-100', border: 'border-teal-400', text: 'text-teal-800', hex: '#ccfbf1' } 
        ];
        const classificationColors = [
             { id: 0, name: "å‚³çµ±ç³»çµ±å¹³å°", colorClass: 'bg-yellow-200', hex: '#fef08a', headerHex: '#fcd34d' }, 
             { id: 1, name: "æ–°èˆˆç³»çµ±å¹³å°", colorClass: 'bg-teal-200', hex: '#99f6e4', headerHex: '#5eead4' }    
        ];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- Helper: Create Drag Item ---
        function createDragItem(id, text, palette, isQ3 = false) {
            const div = document.createElement('div');
            div.id = id;
            div.className = `drag-item ${palette.bg} ${palette.border} ${palette.text} shadow-sm hover:shadow-md transition-all`;
            // Ensure Q3 (now Q4/Q3 in code) items have proper style
            if (isQ3) {
                div.classList.add('category-item'); 
            }
            div.dataset.initialBorderColor = palette.border.replace('border', '#').replace('400', '600'); 
            div.draggable = true;
            div.ondragstart = drag;
            div.ontouchstart = touchStart;
            div.ontouchend = touchEnd;
            div.textContent = text;
            return div;
        }

        // --- Q2 Checkbox Helpers ---
        function createCheckButton(platformName, columnIndex) {
            const uniqueId = `check-${platformName}-${columnIndex}`;
            return `
                <div class="check-box-wrapper">
                    <div id="${uniqueId}" class="check-box" 
                         onclick="toggleSelection('${platformName}', ${columnIndex}, this)">
                        <span class="check-mark opacity-0">âœ“</span>
                    </div>
                </div>
            `;
        }
        
        function toggleSelection(platformName, columnIndex, element) {
            const currentAnswer = answers[currentQuestionIndex] || {};
            const currentlySelected = currentAnswer[platformName];
            
            const row = element.closest('tr');
            if (row) {
                row.querySelectorAll('.check-box').forEach(box => {
                    box.classList.remove('checked');
                    box.querySelector('.check-mark').classList.add('opacity-0');
                });
            }

            if (currentlySelected === columnIndex) {
                currentAnswer[platformName] = -1;
            } else {
                element.classList.add('checked');
                element.querySelector('.check-mark').classList.remove('opacity-0');
                currentAnswer[platformName] = columnIndex;
            }
            
            answers[currentQuestionIndex] = currentAnswer;
        }

        function loadTableSelectionAnswers() {
            const savedAnswers = answers[currentQuestionIndex] || {};
            for (const platformName in savedAnswers) {
                const columnIndex = savedAnswers[platformName];
                if (columnIndex !== -1) {
                    const uniqueId = `check-${platformName}-${columnIndex}`;
                    const element = document.getElementById(uniqueId);
                    if (element) {
                        element.classList.add('checked');
                        element.querySelector('.check-mark').classList.remove('opacity-0');
                    }
                }
            }
        }
        
        // --- Core Navigation & Flow ---

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === quizData.length - 1) {
                nextBtn.textContent = 'å®Œæˆæ¸¬é©— (ç¸½çµ)';
                nextBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                nextBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€é¡Œ';
                nextBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                nextBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
            }
        }
        
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                // Last question, perform final scoring and show results
                showResults();
            }
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            questionStatuses = Array(quizData.length).fill(null);
            answers = {}; // é‡ç½®æ‰€æœ‰ç­”æ¡ˆ
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('question-display').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const currentQuestion = quizData[currentQuestionIndex];
            document.getElementById('question-number').textContent = `#${currentQuestionIndex + 1}`;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            const oldCanvas = document.getElementById('matching-canvas');
            if (oldCanvas) oldCanvas.remove();

            if (currentQuestion.type === 'drag_and_drop') {
                loadQ1_FillBlanks(currentQuestion);
            } else if (currentQuestion.type === 'table_selection') {
                loadQ2_TableSelection(currentQuestion);
            } else if (currentQuestion.type === 'dnd_units_reverse') {
                loadQ3_UnitMatching(currentQuestion); // Q3: å–®ä½é…å° (åè½‰: æ‹–æ›³å–®å…ƒåç¨±åˆ°æè¿°)
            } else if (currentQuestion.type === 'category_bucket') {
                loadQ4_Bucket(currentQuestion); // Q4: æ‡‰ç”¨å¯¦ä¾‹
            } else if (currentQuestion.type === 'category_slots') {
                loadQ5_Slots(currentQuestion); // Q5: I/O å–®å…ƒ
            } else if (currentQuestion.type === 'table_sort_random') { // NEW TYPE NAME
                loadQ6_Table(currentQuestion); // Q6: è¨˜æ†¶é«”
            } else if (currentQuestion.type === 'category_slots_gen') {
                 loadQ7_GenerationSlots(currentQuestion); // Q7: é›»è…¦ä¸–ä»£
            } else if (currentQuestion.type === 'drag_and_drop_2col') {
                 loadQ8_TechMatch(currentQuestion); // Q8: è‹±æ–‡ç¸®å¯«
            } else {
                optionsContainer.className = 'space-y-4 mb-8'; 
                loadMultipleChoice(currentQuestion);
            }
            
            updateNavigationButtons();
        }

        function checkAnswer() {
            const currentQuestion = quizData[currentQuestionIndex];
            let isCorrect = false;

            if (currentQuestion.type === 'drag_and_drop') isCorrect = checkQ1();
            else if (currentQuestion.type === 'table_selection') isCorrect = checkQ2_TableSelection(currentQuestion);
            else if (currentQuestion.type === 'dnd_units_reverse') isCorrect = checkQ3_UnitMatching(currentQuestion);
            else if (currentQuestion.type === 'category_bucket') isCorrect = checkQ4();
            else if (currentQuestion.type === 'category_slots') isCorrect = checkQ5();
            else if (currentQuestion.type === 'table_sort_random') isCorrect = checkQ6();
            else if (currentQuestion.type === 'category_slots_gen') isCorrect = checkQ7_GenerationSlots();
            else if (currentQuestion.type === 'drag_and_drop_2col') isCorrect = checkQ8_TechMatch();
            else isCorrect = checkMultipleChoiceAnswer(currentQuestion); 

            if (isCorrect) {
                questionStatuses[currentQuestionIndex] = 1;
            } else if (isCorrect === false) { 
                questionStatuses[currentQuestionIndex] = 0;
            }
            
            if (isCorrect === true) {
                const nextBtn = document.getElementById('next-btn');
                nextBtn.classList.add('animate-pulse', 'shadow-xl');
                setTimeout(() => {
                    nextBtn.classList.remove('animate-pulse', 'shadow-xl');
                }, 1000);
            }
        }

        // --- Drag & Drop Handlers (Unified) ---

        function drag(event) {
            event.dataTransfer.setData("text/plain", event.target.id);
            if (event.target.dataset.value) event.dataTransfer.setData("value", event.target.dataset.value);
            if (event.target.dataset.categoryId) event.dataTransfer.setData("categoryId", event.target.dataset.categoryId);
            if (event.target.dataset.unitId) event.dataTransfer.setData("unitId", event.target.dataset.unitId);
            if (event.target.dataset.typeId) event.dataTransfer.setData("typeId", event.target.dataset.typeId);
            if (event.target.dataset.correctValue) event.dataTransfer.setData("correctValue", event.target.dataset.correctValue);

            setTimeout(() => { event.target.classList.add('dragging'); }, 0);
        }

        function allowDrop(event) { event.preventDefault(); }

        function dragEnter(event) {
            const target = event.target.closest('.drop-zone, .category-target, .fixed-slot');
            if (target) target.classList.add('drag-over');
        }

        function dragLeave(event) {
            const target = event.target.closest('.drop-zone, .category-target, .fixed-slot');
            if (target) target.classList.remove('drag-over');
        }

        function touchStart(event) {
            const item = event.target.closest('.drag-item, .category-item, .category-item-standard, .unit-match-item');
            if (item) item.classList.add('dragging');
        }
        function touchEnd(event) {
            const item = event.target.closest('.drag-item, .category-item, .category-item-standard, .unit-match-item');
            if (item) item.classList.remove('dragging');
        }
        function touchMove(e) {} 
        
        // Q1 å°ˆç”¨çš„ drop handler (æ‹–æ›³å¡«ç©º)
        function dropQ1(event) {
            event.preventDefault();
            const id = event.dataTransfer.getData("text/plain");
            const el = document.getElementById(id);
            let dropTarget = event.target.closest('.drop-zone');
            
            if (dropTarget && dropTarget.children.length === 0) {
                el.classList.remove('dragging');
                el.style.margin = '0';
                dropTarget.appendChild(el);
                dropTarget.classList.remove('drag-over');
                dropTarget.classList.add('filled');
            } else if (el) {
                el.classList.remove('dragging');
            }
        }
        
        // Q3, Q5, Q6, Q7, Q8 å°ˆç”¨çš„ drop handler (å›ºå®š Slot - LIFO æ›¿æ›é‚è¼¯)
        function dropSlotLIFO(event) {
            event.preventDefault();
            const id = event.dataTransfer.getData("text/plain");
            const el = document.getElementById(id);
            let targetSlot = event.target.closest('.fixed-slot');

            if (targetSlot) {
                if (targetSlot.children.length > 0) {
                    const oldItem = targetSlot.firstElementChild;
                    // Determine source ID based on current question index
                    let sourceId;
                    if (currentQuestionIndex === 2) sourceId = 'q3-unit-source'; // Q3: Unit Match
                    else if (currentQuestionIndex === 3) sourceId = 'q4-source'; // Q4: Bucket
                    else if (currentQuestionIndex === 4) sourceId = 'q5-source'; // Q5: I/O Slots
                    else if (currentQuestionIndex === 5) sourceId = 'q6-source'; // Q6: Memory Table
                    else if (currentQuestionIndex === 6) sourceId = 'q7-source'; // Q7: Generation
                    else if (currentQuestionIndex === 7) sourceId = 'q8-source'; // Q8: Tech Match

                    if (sourceId) {
                        const source = document.getElementById(sourceId);
                        if(source) {
                             source.appendChild(oldItem);
                             oldItem.style.margin = ''; 
                             oldItem.style.width = ''; // Restore
                             if(currentQuestionIndex === 7) oldItem.style.width = '150px'; // Q8 override
                             if(currentQuestionIndex === 5) oldItem.style.width = '100px'; // Q6 override
                        }
                    }
                }
                
                el.classList.remove('dragging');
                
                targetSlot.appendChild(el);
                targetSlot.classList.remove('drag-over');
                el.style.margin = '0';
                el.style.width = '100%';
            } else if (el) {
                el.classList.remove('dragging');
            }
        }
        
        // Q4 å°ˆç”¨çš„ drop handler (Bucket - LIFO æ›¿æ›é‚è¼¯)
        function dropQ3_LIFO(event) {
            event.preventDefault();
            const id = event.dataTransfer.getData("text/plain");
            const el = document.getElementById(id);
            const itemContainer = event.target.closest('.item-container');
            const targetBucket = itemContainer ? itemContainer.closest('.category-target') : null;

            if (!targetBucket) {
                 if (el) el.classList.remove('dragging');
                 return;
            }

            const sourceWrapper = document.getElementById('q4-source'); // Q4 Source ID

            if (itemContainer && sourceWrapper) {
                if (itemContainer.children.length > 0) {
                    const oldItem = itemContainer.firstElementChild;
                    oldItem.style.margin = '4px'; 
                    oldItem.style.width = '110px'; 
                    sourceWrapper.appendChild(oldItem);
                    oldItem.classList.remove('dragging');
                }
                
                el.classList.remove('dragging');
                itemContainer.appendChild(el);
                targetBucket.classList.remove('drag-over');
                
                el.style.margin = '0'; 
                el.style.width = '100%'; 
            } else if (el) {
                el.classList.remove('dragging');
            }
        }
        
        // --- Q1: Fill Blanks ---
        function loadQ1_FillBlanks(q) {
            document.getElementById('question-text').textContent = q.question;
            const wrapper = document.getElementById('question-text');
            const container = document.getElementById('options-container');
            
            wrapper.innerHTML = q.question.replace(/\[__\]/g, (match, index) => 
                `<span class="drop-zone" ondragover="allowDrop(event)" ondrop="dropQ1(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></span>`
            );

            const pool = [...q.options];
            shuffleArray(pool);
            const sourceDiv = document.createElement('div');
            sourceDiv.id = 'q1-source';
            sourceDiv.className = 'flex flex-wrap justify-center gap-4 bg-white p-4 rounded-xl border-2 border-dashed border-gray-300';
            
            pool.forEach((opt, i) => {
                const el = createDragItem(`q1-item-${i}`, opt, colorPalettes[i%7]);
                el.dataset.value = opt;
                sourceDiv.appendChild(el);
            });
            container.appendChild(sourceDiv);
        }

        function checkQ1() {
            let correct = true;
            const zones = document.querySelectorAll('.drop-zone');
            
            zones.forEach((zone, i) => {
                const item = zone.querySelector('.drag-item');
                const answer = quizData[currentQuestionIndex].blanks[i];
                
                zone.style.borderBottomColor = '#a855f7'; // Reset
                if (item) item.style.backgroundColor = ''; // Reset
                
                if (!item || item.dataset.value !== answer) {
                    correct = false;
                    zone.style.borderBottomColor = '#ef4444';
                    if (item) item.style.backgroundColor = '#fca5a5';
                } else {
                    zone.style.borderBottomColor = '#22c55e';
                    item.style.backgroundColor = '#bbf7d0';
                }
            });
            if (correct) showMessage("âœ¨ å…¨å°ï¼å¤ªæ£’äº†ï¼", "bg-green-500");
            else showMessage("âŒ æœ‰éŒ¯èª¤å–”ï¼Œè«‹å†æª¢æŸ¥ä¸€ä¸‹é †åºï¼", "bg-red-500");
            return correct;
        }

        // --- Q2: Table Selection ---
        function loadQ2_TableSelection(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            const table = document.createElement('table');
            table.className = 'table-check-container';

            // Define classification types and randomize order
            const classificationMap = [
                { id: 0, name: "å‚³çµ±ç³»çµ±å¹³å°", colorClass: 'bg-yellow-200', hex: '#fef08a', headerHex: '#fcd34d' }, // Yellow-300
                { id: 1, name: "æ–°èˆˆç³»çµ±å¹³å°", colorClass: 'bg-teal-200', hex: '#99f6e4', headerHex: '#5eead4' }    // Teal-300
            ];
            const classificationTypes = [...classificationMap];
            shuffleArray(classificationTypes); 

            // 1. Header Row
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            
            // Col 1: å¹³å°ç¨®é¡
            const th0 = document.createElement('th');
            th0.textContent = q.columns[0];
            headerRow.appendChild(th0);

            // Col 2 & 3: Randomized Classification Titles (Apply TH Background Color)
            classificationTypes.forEach(type => {
                const th = document.createElement('th');
                th.textContent = type.name;
                // ä½¿ç”¨ headerHex è¨­ç½® TH èƒŒæ™¯è‰²
                th.style.backgroundColor = type.headerHex; 
                th.style.color = '#1f2937'; // Dark text for light background
                th.dataset.columnId = type.id; // Store ID for reference
                headerRow.appendChild(th);
            });

            // 2. Data Rows
            const tbody = table.createTBody();
            const rowsData = [...q.platformData];
            shuffleArray(rowsData); // éš¨æ©Ÿæ’åˆ—å¹³å°ç¨®é¡

            rowsData.forEach((platform, rowIndex) => {
                const row = tbody.insertRow();
                const platformPalette = colorPalettes[rowIndex % colorPalettes.length]; // Row color
                const initialRowColor = platformPalette.hex;
                
                // Column 1: Platform Name (with distinct row color and border)
                const nameCell = row.insertCell();
                nameCell.textContent = platform.name;
                nameCell.style.backgroundColor = initialRowColor; 
                nameCell.dataset.initialColor = initialRowColor; // Store initial color
                
                // Columns 2 & 3: Checkboxes
                classificationTypes.forEach((type) => { 
                    const cell = row.insertCell();
                    cell.dataset.classificationId = type.id; // Store absolute ID (0 or 1) for checking
                    cell.style.backgroundColor = type.hex; // Apply background color based on hex (lighter)
                    cell.dataset.columnColor = type.hex; // Store column color for resetting
                    cell.innerHTML = createCheckButton(platform.name, type.id); // type.id is the absolute classification ID
                });
            });
            
            container.appendChild(table);
            
            // è¼‰å…¥ä¹‹å‰å„²å­˜çš„ç­”æ¡ˆç‹€æ…‹
            loadTableSelectionAnswers();
        }

        function checkQ2_TableSelection(q) {
            const userAnswers = answers[currentQuestionIndex] || {};
            let allCorrect = true;
            let answeredCount = 0;
            const rows = document.querySelectorAll('.table-check-container tbody tr');
            
            // 0. é‡ç½®é¡è‰² (æ¸…é™¤æ‰€æœ‰æª¢æŸ¥æ¨™è¨˜ï¼Œæ¢å¾©åˆå§‹æˆ–æ¬„ä½è‰²)
            rows.forEach(tr => {
                const nameCell = tr.querySelector('td:first-child');
                nameCell.style.backgroundColor = nameCell.dataset.initialColor; 
                tr.querySelectorAll('td:not(:first-child)').forEach(td => {
                    td.style.backgroundColor = td.dataset.columnColor; // Reset to column color
                });
            });


            q.platformData.forEach(platform => {
                const expected = platform.classification;
                const userSelected = userAnswers[platform.name];
                const row = Array.from(rows).find(r => r.querySelector('td:first-child').textContent === platform.name);
                if (!row) return; 

                const nameCell = row.querySelector('td:first-child');
                const clickedCell = userSelected !== undefined && userSelected !== -1 
                                  ? row.querySelector(`td[data-classification-id="${userSelected}"]`) 
                                  : null;

                if (userSelected !== undefined && userSelected !== -1) {
                    answeredCount++;
                    if (userSelected === expected) {
                        // æ­£ç¢ºï¼šä¸æ¨™è¨»ç¶ è‰²ï¼Œç¶­æŒåŸè‰²
                    } else {
                        // éŒ¯èª¤ï¼šç´…è‰²æ¨™è¨»åªåœ¨å¹³å°ç¨®é¡æ¬„ä½
                        allCorrect = false;
                        nameCell.style.backgroundColor = '#fca5a5'; // Red on name cell 
                        
                        // éŒ¯èª¤çš„å‹¾é¸æ¬„ä½ä¹Ÿä½¿ç”¨ç´…è‰²èƒŒæ™¯
                        if (clickedCell) clickedCell.style.backgroundColor = '#fca5a5';
                        
                        // æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆæ¬„ä½ (æ·¡é»ƒè‰²æ¨™è¨˜)
                        const correctCell = row.querySelector(`td[data-classification-id="${expected}"]`);
                        if (correctCell) {
                             correctCell.style.backgroundColor = '#fef08a';
                        }
                    }
                }
            });
            
            if (answeredCount < q.platformData.length) {
                showMessage("è«‹å®Œæˆæ‰€æœ‰å¹³å°çš„åˆ†é¡å‹¾é¸ï¼", "bg-yellow-500");
                return false;
            }

            if (allCorrect) { showMessage("âœ¨ åˆ†é¡å®Œå…¨æ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ åˆ†é¡æœ‰èª¤ï¼Œè«‹æª¢æŸ¥æ¨™è¨»ç´…è‰²çš„é …ç›®ï¼", "bg-red-500"); return false; }
        }

        // --- Q3: Unit Matching (Structure Swapped) ---
        function loadQ3_UnitMatching(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            // Source Items (5 Major Units - Draggable)
            const source = document.createElement('div');
            source.id = 'q3-unit-source';
            source.className = 'flex flex-wrap justify-center gap-3 p-4 min-h-[110px] bg-gray-50 rounded-xl mb-4';
            
            const units = [...q.units];
            shuffleArray(units);

            units.forEach((unit, i) => {
                const palette = colorPalettes[i % colorPalettes.length];
                const el = createDragItem(`q3-unit-item-${i}`, unit.name, palette);
                el.innerHTML = `<span class="text-xl mr-1">${unit.emoji}</span><span>${unit.name}</span>`;
                el.dataset.unitId = unit.unitId;
                el.classList.add('category-item-standard');
                source.appendChild(el);
            });
            container.appendChild(source);

            // Targets (Function Descriptions with Slots)
            const slotsWrapper = document.createElement('div');
            slotsWrapper.className = 'grid grid-cols-1 md:grid-cols-5 gap-4'; 
            
            const descs = [...q.descriptions];
            // Don't shuffle description order for readability, or shuffle if you want harder challenge. 
            // Let's shuffle to make it a real matching task.
            shuffleArray(descs);

            descs.forEach((desc, i) => {
                const slotContainer = document.createElement('div');
                // Style based on description logic or just generic
                slotContainer.className = `flex flex-col items-center p-3 rounded-xl border-2 ${desc.color} shadow-md q3-desc-box`;
                
                const text = document.createElement('div');
                text.className = 'q3-desc-text';
                text.textContent = desc.text;
                slotContainer.appendChild(text);

                const slot = document.createElement('div');
                slot.className = 'fixed-slot unit-match-slot';
                slot.dataset.expectedUnitId = desc.unitId;
                slot.ondragover = allowDrop;
                slot.ondrop = dropSlotLIFO; 
                slot.ondragenter = dragEnter;
                slot.ondragleave = dragLeave;
                
                slotContainer.appendChild(slot);
                slotsWrapper.appendChild(slotContainer);
            });
            container.appendChild(slotsWrapper);
        }

        function checkQ3_UnitMatching(q) {
            let correct = true;
            const slots = document.querySelectorAll('.unit-match-slot');
            let filledCount = 0;

            slots.forEach(slot => {
                const item = slot.children.length > 0 ? slot.firstElementChild : null;
                
                slot.style.borderColor = '#cbd5e1'; 
                if (item) item.style.borderColor = ''; 

                if (item) {
                    filledCount++;
                    const droppedUnitId = item.dataset.unitId;
                    const expectedUnitId = slot.dataset.expectedUnitId;
                    
                    if (droppedUnitId !== expectedUnitId) {
                        correct = false;
                        item.style.borderColor = 'red';
                    } else {
                        item.style.borderColor = '#22c55e';
                    }
                } else {
                    correct = false;
                    slot.style.borderColor = 'red'; // Empty slot is wrong
                }
            });

            if (filledCount < slots.length) {
                showMessage("é‚„æœ‰å–®å…ƒæ²’æœ‰é…å°ï¼", "bg-yellow-500");
                return false;
            }

            if(correct) { showMessage("âœ¨ äº”å¤§å–®å…ƒé…å°æ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ é…å°æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ç´…æ¡†é …ç›®", "bg-red-500"); return false; }
        }

        // --- Q4: Bucket Sort (Application Category - LIFO) ---
        function loadQ4_Bucket(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            // Source
            const source = document.createElement('div');
            source.id = 'q4-source';
            source.className = 'flex flex-wrap justify-center gap-2 p-4 min-h-[100px] border-b-2 border-gray-100 mb-4';
            const items = [...q.items];
            shuffleArray(items);
            items.forEach((item, i) => {
                const el = createDragItem(`q4-item-${i}`, item.name, colorPalettes[i%7], true); 
                el.innerHTML = `<span class="emoji">${item.emoji}</span><span>${item.name}</span>`;
                el.classList.add('category-item'); // Use generic class
                el.dataset.categoryId = item.categoryId;
                source.appendChild(el);
            });
            container.appendChild(source);

            // Buckets
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';
            q.categories.forEach(cat => {
                const bucket = document.createElement('div');
                bucket.className = `category-target ${cat.color} flex flex-col items-center`;
                bucket.dataset.categoryId = cat.id;
                // item-container is the actual drop target
                // Attach D&D handlers to item-container for LIFO logic
                bucket.innerHTML = `<h3 class="font-bold mb-2">${cat.name}</h3><div class="item-container flex flex-wrap justify-center w-full min-h-[100px]" ondragover="allowDrop(event)" ondrop="dropQ3_LIFO(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>`;
                grid.appendChild(bucket);
            });
            container.appendChild(grid);
        }

        function checkQ4() {
            let correct = true;
            // Select all items currently NOT in the source, but inside a bucket
            const items = document.querySelectorAll('#q4-source ~ .grid .category-item'); 
            
            items.forEach(item => {
                const bucket = item.closest('.category-target');
                // Reset border colors first
                item.style.borderColor = item.dataset.initialBorderColor || '';
                
                if (!bucket || bucket.dataset.categoryId !== item.dataset.categoryId) {
                    correct = false;
                    item.style.borderColor = 'red';
                } else {
                    item.style.borderColor = '#22c55e';
                }
            });
            
            if (document.getElementById('q4-source').children.length > 0) {
                showMessage("é‚„æœ‰æ–¹å¡Šæ²’åˆ†é¡å–”ï¼", "bg-yellow-500");
                return false;
            }

            if(correct) { showMessage("âœ¨ åˆ†é¡æ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ åˆ†é¡æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ç´…æ¡†é …ç›®", "bg-red-500"); return false; }
        }


        // --- Q5: Slots (Input/Output) ---
        function loadQ5_Slots(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            // Source
            const source = document.createElement('div');
            source.id = 'q5-source';
            source.className = 'flex flex-wrap justify-center gap-3 p-4 min-h-[110px] bg-gray-50 rounded-xl mb-4';
            const items = [...q.items];
            shuffleArray(items);
            items.forEach((item, i) => {
                const el = createDragItem(`q5-item-${i}`, item.name, colorPalettes[i%7]);
                el.innerHTML = `<span class="emoji">${item.emoji}</span><span>${item.name}</span>`;
                el.classList.add('category-item-standard'); 
                el.dataset.categoryId = item.categoryId;
                source.appendChild(el);
            });
            container.appendChild(source);

            // Categories with Slots (2x2 grid layout per category)
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-6'; 
            
            q.categories.forEach(cat => {
                const section = document.createElement('div');
                section.className = `p-4 rounded-xl ${cat.color}`;
                section.innerHTML = `<h3 class="text-xl font-bold text-center mb-4 text-gray-700">${cat.name}</h3>`;
                
                const slotsDiv = document.createElement('div');
                // Change layout to grid grid-cols-2 for 2x2 box arrangement
                slotsDiv.className = 'slot-container grid grid-cols-2 gap-4 justify-items-center'; 
                
                for(let i=0; i<cat.slots; i++) {
                    const slot = document.createElement('div');
                    // FIX: é€™è£¡çš„ fixed-slot æ˜¯ Q5 çš„ä½œç­”å€ï¼Œéœ€è¦é¡¯ç¤ºå‡ºä¾†
                    slot.className = 'fixed-slot';
                    slot.dataset.expectedCat = cat.id;
                    slot.ondragover = allowDrop;
                    slot.ondrop = dropSlotLIFO; // LIFO Logic (Q5 uses its own sourceId)
                    slot.ondragenter = dragEnter;
                    slot.ondragleave = dragLeave;
                    slotsDiv.appendChild(slot);
                }
                section.appendChild(slotsDiv);
                grid.appendChild(section);
            });
            container.appendChild(grid);
        }
        function checkQ5() {
            let correct = true;
            const slots = document.querySelectorAll('.fixed-slot');
            let filledCount = 0;

            // Only check slots within the Q5 area to avoid conflict with other questions if any
            // Since we rebuild options-container, document.querySelectorAll is fine for current Q
            
            slots.forEach(slot => {
                const item = slot.children.length > 0 ? slot.firstElementChild : null;

                slot.style.borderColor = '#cbd5e1'; // Reset
                if (item) item.style.borderColor = ''; // Reset

                if (item) {
                    filledCount++;
                    if (item.dataset.categoryId !== slot.dataset.expectedCat) {
                        correct = false;
                        item.style.borderColor = 'red';
                    } else {
                        item.style.borderColor = '#22c55e';
                    }
                } else {
                    // Q5 requires all slots filled? The prompt implies "put devices into correct category". 
                    // There are 8 items and 8 slots (4 input + 4 output). So yes.
                    correct = false;
                    slot.style.borderColor = 'red'; 
                }
            });

            if (filledCount < 8) { // 8 total items
                 showMessage("é‚„æœ‰é€±é‚Šè¨­å‚™æ²’åˆ†é¡å–”ï¼", "bg-yellow-500");
                 return false;
            }

            if(correct) { showMessage("âœ¨ IO å–®å…ƒåˆ†é¡æ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ åˆ†é¡æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ç´…æ¡†é …ç›®", "bg-red-500"); return false; }
        }

        // --- Q6: Table Sort (Memory) ---
        function loadQ6_Table(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            // Pick a random variation
            const randomVar = q.variations[Math.floor(Math.random() * q.variations.length)];
            
            // Source (Pool of items) - Only 1 set remains (4 items total)
            const source = document.createElement('div');
            source.id = 'q6-source';
            source.className = 'flex flex-wrap justify-center gap-3 p-4 min-h-[110px] bg-gray-50 rounded-xl mb-4 overflow-y-auto max-h-[150px]';
            
            // Create 1 set of choices
            q.sourceItems.forEach((item, idx) => {
                const el = createDragItem(`q6-item-${idx}`, item.name, colorPalettes[idx+2]); 
                el.innerHTML = `<span class="emoji">${item.emoji}</span><span>${item.name}</span>`;
                el.classList.add('category-item-standard');
                el.dataset.typeId = item.id;
                el.style.width = '100px';
                el.style.height = '70px';
                source.appendChild(el);
            });
            
            container.appendChild(source);

            // Table Rows
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'q5-table-wrapper';
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'q5-row';
            
            // Start Label (Title - Large Font)
            const labelTitle = document.createElement('div');
            labelTitle.className = 'q5-speed-title'; // ä½¿ç”¨ç‰¹æ®Šå¤§æ¨™é¡Œæ¨£å¼
            labelTitle.innerHTML = `${randomVar.labelStart} <div class="font-normal text-sm text-gray-500">${randomVar.labelEnd}</div>`;
            rowDiv.appendChild(labelTitle);

            // Slots
            const slotsDiv = document.createElement('div');
            // Ensure horizontal layout with flex-nowrap
            slotsDiv.className = 'q5-slots flex flex-row flex-nowrap gap-4';
            
            randomVar.order.forEach((correctType, sIdx) => {
                const slot = document.createElement('div');
                // FIX: é€™è£¡çš„ fixed-slot æ˜¯ Q6 çš„ä½œç­”å€ï¼Œéœ€è¦é¡¯ç¤ºå‡ºä¾†
                slot.className = 'fixed-slot q5-target-slot';
                slot.style.width = '100px'; 
                slot.style.height = '70px'; 
                slot.dataset.correctType = correctType; 
                slot.ondragover = allowDrop;
                slot.ondrop = dropSlotLIFO; // LIFO Logic (Q6 uses its own sourceId)
                slot.ondragenter = dragEnter;
                slot.ondragleave = dragLeave;
                slotsDiv.appendChild(slot);
            });
            rowDiv.appendChild(slotsDiv);

            tableWrapper.appendChild(rowDiv);
            container.appendChild(tableWrapper);
        }

        function checkQ6() {
            let correct = true;
            const slots = document.querySelectorAll('.q5-target-slot');
            let filledCount = 0;

            slots.forEach(slot => {
                const item = slot.children.length > 0 ? slot.firstElementChild : null;

                slot.style.borderColor = '#cbd5e1'; // Reset
                if (item) item.style.borderColor = ''; // Reset

                if (item) {
                    filledCount++;
                    if (item.dataset.typeId !== slot.dataset.correctType) {
                        correct = false;
                        item.style.borderColor = 'red';
                    } else {
                        item.style.borderColor = '#22c55e';
                    }
                } else {
                    correct = false;
                    slot.style.borderColor = 'red'; 
                }
            });

            if (filledCount < slots.length) {
                showMessage("é‚„æœ‰ç©ºæ ¼æ²’å¡«æ»¿å–”ï¼", "bg-yellow-500");
                return false;
            }

            if(correct) { showMessage("âœ¨ æ’åˆ—é †åºæ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ é †åºæœ‰èª¤ï¼Œè«‹å†è©¦è©¦çœ‹ï¼", "bg-red-500"); return false; }
        }
        
        // --- Q7: Generation Slots ---
        function loadQ7_GenerationSlots(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            // Source (Items to drag)
            const source = document.createElement('div');
            source.id = 'q7-source';
            source.className = 'flex flex-wrap justify-center gap-3 p-4 min-h-[110px] bg-gray-50 rounded-xl mb-4';
            
            const items = [...q.items];
            shuffleArray(items);
            items.forEach((item, i) => {
                const el = createDragItem(`q7-item-${i}`, item.name, colorPalettes[i % colorPalettes.length]);
                el.innerHTML = `<span class="emoji">${item.emoji}</span><span>${item.name}</span>`;
                el.classList.add('category-item-standard');
                el.dataset.categoryId = item.categoryId; // Gen ID
                el.style.width = '140px';
                el.style.height = '60px';
                source.appendChild(el);
            });
            container.appendChild(source);

            // Using Grid instead of Table for horizontal slots to ensure flexible layout
            const genContainer = document.createElement('div');
            genContainer.className = 'gen-container';

            q.categories.forEach(cat => {
                 const col = document.createElement('div');
                 col.className = 'gen-column';
                 
                 const header = document.createElement('div');
                 header.className = 'gen-header';
                 header.textContent = cat.name;
                 header.style.backgroundColor = cat.color.replace('bg-', 'var(--tw-bg-opacity, 1) '); // Tailwind hack or just map
                 // Map tailwind bg class to style for simplicity in dynamic generation
                 if(cat.color.includes('red')) header.style.backgroundColor = '#ef4444';
                 if(cat.color.includes('orange')) header.style.backgroundColor = '#f97316';
                 if(cat.color.includes('yellow')) header.style.backgroundColor = '#eab308';
                 if(cat.color.includes('green')) header.style.backgroundColor = '#22c55e';
                 if(cat.color.includes('blue')) header.style.backgroundColor = '#3b82f6';

                 const body = document.createElement('div');
                 body.className = 'gen-body';
                 
                 for(let i=0; i<cat.slots; i++) {
                    const slot = document.createElement('div');
                    // FIX: ä½¿ç”¨ fixed-slot ç¢ºä¿å¯æ‹–æ›³
                    slot.className = 'fixed-slot gen-target-slot';
                    slot.dataset.expectedCat = cat.id;
                    slot.style.width = '140px'; 
                    slot.style.height = '60px'; 
                    slot.ondragover = allowDrop;
                    slot.ondrop = dropSlotLIFO;
                    slot.ondragenter = dragEnter;
                    slot.ondragleave = dragLeave;
                    body.appendChild(slot);
                 }
                 
                 col.appendChild(header);
                 col.appendChild(body);
                 genContainer.appendChild(col);
            });
            container.appendChild(genContainer);
        }

        function checkQ7_GenerationSlots() {
            let correct = true;
            const slots = document.querySelectorAll('.gen-target-slot');
            let filledCount = 0;

            slots.forEach(slot => {
                const item = slot.children.length > 0 ? slot.firstElementChild : null;
                
                slot.style.borderColor = '#cbd5e1'; // Reset
                if (item) item.style.borderColor = ''; // Reset

                if (item) {
                    filledCount++;
                    if (item.dataset.categoryId !== slot.dataset.expectedCat) {
                        correct = false;
                        item.style.borderColor = 'red';
                    } else {
                        item.style.borderColor = '#22c55e';
                    }
                } else {
                    correct = false;
                    slot.style.borderColor = 'red'; 
                }
            });

            if (filledCount < slots.length) {
                showMessage("é‚„æœ‰å…ƒä»¶æ²’æœ‰åˆ†é¡å–”ï¼", "bg-yellow-500");
                return false;
            }

            if(correct) { showMessage("âœ¨ é›»è…¦ä¸–ä»£åˆ†é¡æ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ åˆ†é¡æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ç´…æ¡†é …ç›®", "bg-red-500"); return false; }
        }

        // --- Q8: Tech Match ---
        function loadQ8_TechMatch(q) {
            document.getElementById('question-text').textContent = q.question;
            const container = document.getElementById('options-container');

            // Source (English Abbreviations)
            const source = document.createElement('div');
            source.id = 'q8-source';
            source.className = 'flex flex-wrap justify-center gap-3 p-4 min-h-[110px] bg-gray-50 rounded-xl mb-4';
            
            const items = [...q.leftItems];
            shuffleArray(items);

            items.forEach((item, i) => {
                const palette = colorPalettes[i];
                const el = createDragItem(`q8-item-${i}`, item.name, palette);
                el.dataset.correctValue = item.value;
                el.style.width = '150px';
                el.style.height = '60px';
                
                // Increase font size for Q8 English items
                el.style.fontSize = '1.8rem'; // Bigger font
                el.style.fontWeight = 'bold';

                source.appendChild(el);
            });
            container.appendChild(source);

            // Targets (Chinese Names)
            const targetsWrapper = document.createElement('div');
            targetsWrapper.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
            
            const rightItems = [...q.rightItems];
            shuffleArray(rightItems);

            rightItems.forEach((target, i) => {
                 const targetDiv = document.createElement('div');
                 const palette = colorPalettes[i + 3];
                 targetDiv.className = `p-4 rounded-xl border-4 border-dashed ${palette.border} ${palette.bg} flex flex-col items-center`;
                 targetDiv.innerHTML = `<h3 class="font-bold text-lg text-gray-700">${target.name}</h3>`;

                 const slot = document.createElement('div');
                 slot.className = 'fixed-slot q8-target-slot mt-2';
                 slot.style.width = '150px';
                 slot.style.height = '60px';
                 slot.dataset.expectedValue = target.correctValue;
                 slot.ondragover = allowDrop;
                 slot.ondrop = dropSlotLIFO;
                 slot.ondragenter = dragEnter;
                 slot.ondragleave = dragLeave;

                 targetDiv.appendChild(slot);
                 targetsWrapper.appendChild(targetDiv);
            });
            container.appendChild(targetsWrapper);
        }

        function checkQ8_TechMatch() {
            let correct = true;
            const slots = document.querySelectorAll('.q8-target-slot');
            let filledCount = 0;

            slots.forEach(slot => {
                const item = slot.children.length > 0 ? slot.firstElementChild : null;

                slot.style.borderColor = '#cbd5e1'; // Reset
                if (item) item.style.borderColor = ''; // Reset

                if (item) {
                    filledCount++;
                    if (item.dataset.correctValue !== slot.dataset.expectedValue) {
                        correct = false;
                        item.style.borderColor = 'red';
                    } else {
                        item.style.borderColor = '#22c55e';
                    }
                } else {
                    correct = false;
                    slot.style.borderColor = 'red'; 
                }
            });

            if (filledCount < slots.length) {
                showMessage("é‚„æœ‰é …ç›®æ²’æœ‰é…å°å–”ï¼", "bg-yellow-500");
                return false;
            }

            if(correct) { showMessage("âœ¨ è‹±æ–‡ç¸®å¯«é…å°æ­£ç¢ºï¼", "bg-green-500"); return true; }
            else { showMessage("âŒ é…å°æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ç´…æ¡†é …ç›®ï¼", "bg-red-500"); return false; }
        }


        // --- Final Scoring and Results ---

        function showResults() {
            // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
            let finalScore = 0;
            quizData.forEach((q, index) => {
                if (questionStatuses[index] === 1) {
                    finalScore++;
                }
            });

            const total = quizData.length;
            
            document.getElementById('question-display').classList.add('hidden');
            document.getElementById('result-display').classList.remove('hidden');

            let message = '';
            let icon = '';
            let colorClass = '';

            if (finalScore === total) {
                message = "å¤ªç¥å•¦ï¼å®Œç¾æ»¿åˆ†ï¼";
                icon = "ğŸ†";
                colorClass = "text-yellow-500";
            } else if (finalScore >= total * 0.8) {
                message = "å¾ˆæ£’å–”ï¼ç¹¼çºŒä¿æŒï¼";
                icon = "ğŸŒŸ";
                colorClass = "text-blue-500";
            } else if (finalScore >= total * 0.6) {
                message = "é‚„ä¸éŒ¯ï¼Œå†æ¥å†å²ï¼";
                icon = "ğŸ™‚";
                colorClass = "text-green-500";
            } else {
                message = "åˆ¥æ°£é¤’ï¼Œå†è¤‡ç¿’ä¸€ä¸‹ï¼";
                icon = "ğŸ“š";
                colorClass = "text-red-500";
            }

            document.getElementById('result-icon').textContent = icon;
            document.getElementById('final-message').textContent = message;
            document.getElementById('final-message').className = `text-3xl font-extrabold mb-2 ${colorClass}`;
            document.getElementById('final-score-number').textContent = finalScore;
            document.getElementById('final-score-text').textContent = `æ»¿åˆ†æ˜¯ ${total} é¡Œ`;
        }

        function restartQuiz() {
            document.getElementById('result-display').classList.add('hidden');
            startQuiz();
        }

        // è‡ªå®šç¾©è¨Šæ¯æ¡† (è‡ªå‹•éš±è—ä¸¦ç½®æ–¼é ‚éƒ¨ä¸­å¤®)
        function showMessage(msg, bgColor) {
            let messageBox = document.getElementById('message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'message-box';
                document.body.appendChild(messageBox);
            }
            messageBox.textContent = msg;
            messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-8 py-4 rounded-xl shadow-2xl text-white font-bold text-lg text-center transition-all duration-300 opacity-100 scale-100 ${bgColor} border-4 border-white`;
            
            setTimeout(() => {
                const box = document.getElementById('message-box');
                if (box) {
                    box.classList.remove('opacity-100', 'scale-100');
                    box.classList.add('opacity-0', 'scale-90');
                    setTimeout(() => box.remove(), 300);
                }
            }, 3000); 
        }
    </script>
</body>
</html>